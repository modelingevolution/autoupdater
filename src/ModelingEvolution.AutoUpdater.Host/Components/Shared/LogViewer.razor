@using ModelingEvolution.AutoUpdater.Services
@using Microsoft.Extensions.Logging
@inject IInMemoryLoggerSink LoggerSink
@inject IProgressService ProgressService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="logger-viewer">
    @if ((ProgressService.IsRunning || _showCompletedProgress) && !_progressDismissed)
    {
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center;">
                            <MudIcon Icon="@(ProgressService.IsRunning ? Icons.Material.Filled.Build : Icons.Material.Filled.CheckCircle)" class="mr-3" />
                            <MudText Typo="Typo.h6">@(ProgressService.IsRunning ? "Update Progress" : "Update Completed")</MudText>
                        </div>
                        @if (!ProgressService.IsRunning)
                        {
                            <MudTooltip Text="Dismiss">
                                <MudIconButton Icon="@Icons.Material.Filled.Close"
                                               OnClick="DismissProgress"
                                               Size="Size.Small" />
                            </MudTooltip>
                        }
                    </div>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body1" Class="mb-2">@ProgressService.CurrentOperation</MudText>
                <MudProgressLinear Value="@ProgressService.ProgressPercentage" Class="mb-2" Color="@(ProgressService.IsRunning ? Color.Primary : Color.Success)" />
                <MudText Typo="Typo.caption">@ProgressService.ProgressPercentage%</MudText>
            </MudCardContent>
        </MudCard>
    }

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center;">
                        <MudIcon Icon="Icons.Material.Filled.Terminal" class="mr-3" />
                        <MudText Typo="Typo.h6">Update Logs</MudText>
                        <MudChip T="string" Text="@(_logEntries.Count.ToString())" Size="Size.Small" Class="ml-2" />
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <MudTooltip Text="Copy logs to clipboard">
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyLogsToClipboard"
                                           Size="Size.Small"
                                           Disabled="@(_logEntries.Count == 0)" />
                        </MudTooltip>
                        <MudTooltip Text="@(_autoScroll ? "Disable auto-scroll" : "Enable auto-scroll")">
                            <MudIconButton Icon="@(_autoScroll ? Icons.Material.Filled.PauseCircleFilled : Icons.Material.Filled.PlayCircleFilled)"
                                           OnClick="ToggleAutoScroll"
                                           Size="Size.Small" />
                        </MudTooltip>
                    </div>
                </div>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent Style="padding: 0;">
            <div class="log-container" style="height: 400px; overflow-y: auto; background-color: #1e1e1e; font-family: 'Courier New', monospace; font-size: 12px;" @ref="logContainer">
                @if (_logEntries.Count > 0)
                {
                    <ObservableForEach Context="log" IsNotifyPropertyChangedEnabled="false" ItemSource="_logEntries">
                    
                        <div class="log-entry" style="padding: 4px 12px; border-bottom: 1px solid #333; color: @GetLogColor(log.Level);">
                            <span style="color: #888; margin-right: 8px;">@log.Timestamp.ToString("HH:mm:ss.fff")</span>
                            <span style="color: @GetLevelColor(log.Level); margin-right: 8px; font-weight: bold;">[@log.Level.ToString().ToUpper()]</span>
                            @* <span style="color: #6a9bd1; margin-right: 8px;">@log.Category</span> *@
                            <span>@log.Message</span>
                            @if (log.Exception != null)
                            {
                                <div style="color: #ff6b6b; margin-top: 4px; padding-left: 16px; font-size: 11px;">
                                    @log.Exception.Message
                                </div>
                            }
                        </div>
                    
                    </ObservableForEach>
                }
                else
                {
                    <div style="padding: 20px; text-align: center; color: #888;">
                        No logs available
                    </div>
                }
            </div>
        </MudCardContent>
    </MudCard>
</div>

@code {
    private IReadOnlyList<LogEntry> _logEntries = null!;
    private ElementReference logContainer;
    private bool _autoScroll = true;
    private bool _showCompletedProgress = false;
    private bool _progressDismissed = false;
    private bool _wasRunning = false;
    private System.Timers.Timer? _completionTimer;

    protected override void OnInitialized()
    {
        // Load existing logs
        _logEntries = LoggerSink.LogEntries;

        ProgressService.Changed += OnProgressChanged;
        _wasRunning = ProgressService.IsRunning;
    }


    private async void OnProgressChanged()
    {
        await InvokeAsync(() =>
        {
            var isRunning = ProgressService.IsRunning;

            // Detect transition from running to not running (operation completed)
            if (_wasRunning && !isRunning)
            {
                _showCompletedProgress = true;
                _progressDismissed = false;

                // Disable log capturing when operation completes
                LoggerSink.Enabled = false;

                // Auto-dismiss after 10 seconds
                _completionTimer?.Dispose();
                _completionTimer = new System.Timers.Timer(10000);
                _completionTimer.Elapsed += (s, e) =>
                {
                    InvokeAsync(() =>
                    {
                        _showCompletedProgress = false;
                        _completionTimer?.Dispose();
                        StateHasChanged();
                    });
                };
                _completionTimer.AutoReset = false;
                _completionTimer.Start();
            }
            // Detect transition from not running to running (new operation started)
            else if (!_wasRunning && isRunning)
            {
                _showCompletedProgress = false;
                _progressDismissed = false;
                _completionTimer?.Dispose();

                // Re-enable log capturing when new operation starts
                LoggerSink.Enabled = true;
            }

            _wasRunning = isRunning;
            StateHasChanged();
        });
    }


    private void DismissProgress()
    {
        _progressDismissed = true;
        _showCompletedProgress = false;
        _completionTimer?.Dispose();
        StateHasChanged();
    }

    private async Task CopyLogsToClipboard()
    {
        if (_logEntries.Count == 0)
            return;

        var logsText = string.Join("\n", _logEntries.Select(log =>
            $"{log.Timestamp:HH:mm:ss.fff} [{log.Level.ToString().ToUpper()}] {log.Message}" +
            (log.Exception != null ? $"\n    {log.Exception.Message}" : "")));

        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", logsText);
    }


    private void ToggleAutoScroll()
    {
        _autoScroll = !_autoScroll;
        StateHasChanged();
    }

    private string GetLogColor(LogLevel level) => level switch
    {
        LogLevel.Trace => "#888",
        LogLevel.Debug => "#888",
        LogLevel.Information => "#fff",
        LogLevel.Warning => "#ffa726",
        LogLevel.Error => "#f44336",
        LogLevel.Critical => "#d32f2f",
        _ => "#fff"
    };

    private string GetLevelColor(LogLevel level) => level switch
    {
        LogLevel.Trace => "#9e9e9e",
        LogLevel.Debug => "#607d8b", 
        LogLevel.Information => "#4caf50",
        LogLevel.Warning => "#ff9800",
        LogLevel.Error => "#f44336",
        LogLevel.Critical => "#d32f2f",
        _ => "#fff"
    };

    public void Dispose()
    {
        ProgressService.Changed -= OnProgressChanged;
        _completionTimer?.Dispose();
    }
}

<style>
    .logger-viewer .log-container {
        scrollbar-width: thin;
        scrollbar-color: #666 #333;
    }

    .logger-viewer .log-container::-webkit-scrollbar {
        width: 8px;
    }

    .logger-viewer .log-container::-webkit-scrollbar-track {
        background: #333;
    }

    .logger-viewer .log-container::-webkit-scrollbar-thumb {
        background: #666;
        border-radius: 4px;
    }

    .logger-viewer .log-container::-webkit-scrollbar-thumb:hover {
        background: #888;
    }

    .logger-viewer .log-entry:hover {
        background-color: #2a2a2a;
    }
</style>