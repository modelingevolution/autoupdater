@using ModelingEvolution.AutoUpdater
@using ModelingEvolution.AutoUpdater.Services
@using ModelingEvolution.AutoUpdater.Models
@inject IBackupService BackupService
@inject PackageManager PackageManager
@inject DockerComposeConfigurationModel ConfigModel
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<BackupListDialog> Logger

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-width: 1200px;">
            @if (_isLoading)
            {
                <div style="display: flex; justify-content: center; padding: 40px;">
                    <MudProgressCircular Indeterminate="true" Size="Size.Large" />
                </div>
            }
            else if (_backups == null || _backups.Count == 0)
            {
                <MudAlert Severity="Severity.Info">No backups found for this package.</MudAlert>
            }
            else
            {
                <MudTable Items="@_backups" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                    <HeaderContent>
                        <MudTh>Filename</MudTh>
                        <MudTh>Package Version</MudTh>
                        <MudTh>Size</MudTh>
                        <MudTh>Created</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Filename">
                            <MudTooltip Text="@context.FullPath">
                                <MudText Typo="Typo.body2">@context.Filename</MudText>
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="Package Version">@context.Version</MudTd>
                        <MudTd DataLabel="Size">@context.Size</MudTd>
                        <MudTd DataLabel="Created">@context.CreatedDate.ToString("yyyy-MM-dd HH:mm")</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudButton Size="Size.Small"
                                      Variant="Variant.Filled"
                                      Color="Color.Default"
                                      StartIcon="@Icons.Material.Filled.Restore"
                                      OnClick="@(() => RestoreBackupAsync(context.Filename))"
                                      Disabled="@_isRestoring">
                                Restore
                            </MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <MudText Typo="Typo.caption" Class="mt-2">
                    Total: @_totalCount backups | @_totalSize
                </MudText>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
        <MudButton Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Refresh"
                   OnClick="LoadBackupsAsync"
                   Disabled="@_isLoading">
            Refresh
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public PackageName PackageName { get; set; }

    private List<BackupInfo>? _backups;
    private int _totalCount;
    private string _totalSize = string.Empty;
    private bool _isLoading = false;
    private bool _isRestoring = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadBackupsAsync();
    }

    private async Task LoadBackupsAsync()
    {
        _isLoading = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Loading backups for package: {PackageName}", PackageName);

            var config = ConfigModel.GetPackage(PackageName);
            if (config == null)
            {
                Snackbar.Add($"Package {PackageName} not found", Severity.Error);
                return;
            }

            var result = await BackupService.ListBackupsAsync(config.HostComposeFolderPath);

            if (result.Success)
            {
                _backups = result.Backups;
                _totalCount = result.TotalCount;
                _totalSize = result.TotalSize;
                Logger.LogInformation("Loaded {Count} backups", _totalCount);
            }
            else
            {
                Snackbar.Add($"Failed to load backups: {result.Error}", Severity.Error);
                Logger.LogError("Failed to load backups: {Error}", result.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading backups for package: {PackageName}", PackageName);
            Snackbar.Add($"Error loading backups: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RestoreBackupAsync(string filename)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Confirm Restore",
            $"Are you sure you want to restore backup '{filename}'? This will stop the current services and restore data from the backup.",
            yesText: "Restore",
            cancelText: "Cancel");

        if (confirmed != true)
            return;

        _isRestoring = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Restoring backup {Filename} for package: {PackageName}", filename, PackageName);

            var config = ConfigModel.GetPackage(PackageName);
            if (config == null)
            {
                Snackbar.Add($"Package {PackageName} not found", Severity.Error);
                return;
            }

            var result = await PackageManager.RestorePackageAsync(config, filename);

            if (result.Success)
            {
                Snackbar.Add($"Backup restored successfully", Severity.Success);
                Logger.LogInformation("Backup restored: {Filename}", filename);

                // Reload the list after successful restore
                await LoadBackupsAsync();
            }
            else
            {
                Snackbar.Add($"Restore failed: {result.Error}", Severity.Error);
                Logger.LogError("Restore failed: {Error}", result.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error restoring backup {Filename} for package: {PackageName}", filename, PackageName);
            Snackbar.Add($"Error restoring backup: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isRestoring = false;
            StateHasChanged();
        }
    }

    private void Close()
    {
        MudDialog.Close();
    }
}
