@using ModelingEvolution.AutoUpdater
@using ModelingEvolution.AutoUpdater.Services
@inject PackageManager PackageManager
@inject DockerComposeConfigurationModel ConfigModel
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ILogger<BackupButton> Logger

<MudMenu Icon="@Icons.Material.Filled.Backup"
         Color="Color.Default"
         Size="Size.Small"
         AnchorOrigin="Origin.BottomCenter"
         TransformOrigin="Origin.TopCenter"
         Dense="true">
    <MudMenuItem OnClick="CreateBackupAsync" Disabled="@_isCreatingBackup">
        @if (_isCreatingBackup)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            <span>&nbsp;Creating backup...</span>
        }
        else
        {
            @Icons.Material.Filled.Add
            <span>&nbsp;Create Backup</span>
        }
    </MudMenuItem>
    <MudMenuItem OnClick="ManageBackupsAsync">
        @Icons.Material.Filled.List
        <span>&nbsp;Manage Backups</span>
    </MudMenuItem>
</MudMenu>

@code {
    [Parameter] public PackageName PackageName { get; set; }

    private bool _isCreatingBackup = false;

    private async Task CreateBackupAsync()
    {
        if (_isCreatingBackup) return;

        _isCreatingBackup = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Creating backup for package: {PackageName}", PackageName);

            var config = ConfigModel.GetPackage(PackageName);
            if (config == null)
            {
                Snackbar.Add($"Package {PackageName} not found", Severity.Error);
                return;
            }

            var result = await PackageManager.BackupPackageAsync(config);

            if (result.Success)
            {
                Snackbar.Add($"Backup created successfully: {result.BackupFilePath}", Severity.Success);
                Logger.LogInformation("Backup created: {BackupFile}", result.BackupFilePath);
            }
            else
            {
                Snackbar.Add($"Backup failed: {result.Error}", Severity.Error);
                Logger.LogError("Backup failed: {Error}", result.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating backup for package: {PackageName}", PackageName);
            Snackbar.Add($"Error creating backup: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCreatingBackup = false;
            StateHasChanged();
        }
    }

    private async Task ManageBackupsAsync()
    {
        var parameters = new DialogParameters
        {
            ["PackageName"] = PackageName
        };

        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        };

        await DialogService.ShowAsync<BackupListDialog>("Manage Backups", parameters, options);
    }
}
